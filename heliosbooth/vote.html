<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8">
  <title>Wahlkabine</title>
  <link rel="stylesheet" type="text/css" href="css/booth.css" />
  <link rel="stylesheet" type="text/css" href="css/forms.css" />

<!--
  <script language="javascript" src="js/jscrypto/class.js"></script>
  <script language="javascript" src="js/jscrypto/bigint.dummy.js"></script>
  <script language="javascript" src="js/jscrypto/jsbn.js"></script>
  <script language="javascript" src="js/jscrypto/jsbn2.js"></script>
  <script language="javascript" src="js/jscrypto/sjcl.js"></script>
  <script language="javascript" src="js/underscore-min.js"></script>
  <script language="javascript" src="js/jquery-1.2.2.min.js"></script>
  <script language="javascript" src="js/jquery.query-2.1.5.js"></script>
  <script language="javascript" src="js/jquery-jtemplates.js"></script>
  <script language="javascript" src="js/jquery.json.min.js"></script>
  <script language="javascript" src="js/jscrypto/bigint.js"></script>
  <script language="javascript" src="js/jscrypto/random.js"></script>
  <script language="javascript" src="js/jscrypto/elgamal.js"></script>
  <script language="javascript" src="js/jscrypto/sha1.js"></script>
  <script language="javascript" src="js/jscrypto/sha2.js"></script>
  <script language="javascript" src="js/jscrypto/helios.js"></script>-->
  
  <script language="javascript" src="js/20160507-helios-booth-compressed.js"></script>
</head>

<body>
<div id="wrapper">
<div id="banner" class="edge">
  <div class="banner-content" style="position:relative; display:flex; align-items:center; justify-content:center;">
    <!-- Sprach-Icon links oben -->
    <div id="lang-switch" style="position:sticky; left:12px; top:8px; display:flex; gap:6px; align-items:center;">
      <a id="lang-de" class="lang-link" href="#" onclick="BOOTH.switch_language('de'); return false;" title="Deutsch" aria-label="Deutsch">
        <img src="static/lang/flag-de.svg" alt="DE" style="width:26px; height:18px; vertical-align:middle; border-radius:2px;"/>
      </a>
      <a id="lang-en" class="lang-link" href="#" onclick="BOOTH.switch_language('en'); return false;" title="English" aria-label="English">
        <img src="static/lang/flag-en.svg" alt="EN" style="width:26px; height:18px; vertical-align:middle; border-radius:2px;"/>
      </a>
    </div>

    <!-- Titel in der Mitte bleibt unverändert -->
    <span class="banner-title">Wahlkabine</span>

    <!-- Exit bleibt rechts -->
    <a class="banner-exit" href="javascript:BOOTH.exit();" style="position:absolute; right:12px;">Verlassen</a>
  </div>
</div>


<div id="content">

<div id="header">
</div>

<script language="javascript">
// utils
BOOTH = {};

BOOTH.setup_templates = function() {
    if (BOOTH.templates_setup_p)
        return;

    var cache_bust = "?cb=" + new Date().getTime();

    // Check for lang parameter or localStorage
    var params = new URLSearchParams(window.location.search);
    var lang = params.get('lang') || localStorage.getItem('helios_language');
    
    // Ensure consistency
    if (lang) {
        localStorage.setItem('helios_language', lang);
    }

    BOOTH.language = (lang === 'en') ? 'en' : 'de';

    var template_prefix = "templates/";
    if (lang === 'en') {
        template_prefix = "templates/en/";

        // Translate static UI elements
        $('#progress_1').text("(1) Select");
        $('#progress_2').text("(2) Review");
        $('#progress_3').text("(3) Submit");
        $('.banner-title').text("Voting Booth");
        $('.banner-exit').text("Exit");
        $('#encrypting_message').text("Your ballot is being encrypted.");
        $('#encrypting_submessage').text("This won't take long :)");
        
        $('#lang-en').addClass('lang-active');
    } else {
        $('#lang-de').addClass('lang-active');
    }

    $('#header').setTemplateURL(template_prefix + "header.html" + cache_bust);
    $('#election_div').setTemplateURL(template_prefix + "election.html" + cache_bust);
    $('#question_div').setTemplateURL(template_prefix + "question.html" + cache_bust);
    $('#seal_div').setTemplateURL(template_prefix + "seal.html" + cache_bust);
    $('#audit_div').setTemplateURL(template_prefix + "audit.html" + cache_bust);
    $('#footer').setTemplateURL(template_prefix + "footer.html" + cache_bust);

    BOOTH.templates_setup_p = true;
};

BOOTH.switch_language = function(lang) {
    BOOTH.language = lang;
    // 0. Save preference
    localStorage.setItem('helios_language', lang);

    // 1. Update URL (visual only, no reload)
    var url = new URL(window.location);
    url.searchParams.set('lang', lang);
    window.history.pushState({}, '', url);

    // 2. Update static texts
    if (lang === 'en') {
        $('#progress_1').text("(1) Select");
        $('#progress_2').text("(2) Review");
        $('#progress_3').text("(3) Submit");
        $('.banner-title').text("Voting Booth");
        $('.banner-exit').text("Exit");
        $('#encrypting_message').text("Your ballot is being encrypted.");
        $('#encrypting_submessage').text("This won't take long :)");
        
        $('#lang-en').addClass('lang-active');
        $('#lang-de').removeClass('lang-active');
    } else {
        $('#progress_1').text("(1) Wählen");
        $('#progress_2').text("(2) Überprüfung");
        $('#progress_3').text("(3) Abschicken");
        $('.banner-title').text("Wahlkabine");
        $('.banner-exit').text("Verlassen");
        $('#encrypting_message').text("Dieser Stimmzettel wird nun verschlüsselt.");
        $('#encrypting_submessage').text("Das dauert nicht lange :)");
        
        $('#lang-de').addClass('lang-active');
        $('#lang-en').removeClass('lang-active');
    }

    // 3. Reload templates
    var template_prefix = (lang === 'en') ? "templates/en/" : "templates/";
    var cache_bust = "?cb=" + new Date().getTime();

    $('#header').setTemplateURL(template_prefix + "header.html" + cache_bust);
    $('#election_div').setTemplateURL(template_prefix + "election.html" + cache_bust);
    $('#question_div').setTemplateURL(template_prefix + "question.html" + cache_bust);
    $('#seal_div').setTemplateURL(template_prefix + "seal.html" + cache_bust);
    $('#audit_div').setTemplateURL(template_prefix + "audit.html" + cache_bust);
    $('#footer').setTemplateURL(template_prefix + "footer.html" + cache_bust);

    // 4. Re-render current view
    if (BOOTH.state && BOOTH.state.type) {
        if (BOOTH.state.type === 'election') {
            BOOTH.show_election();
        } else if (BOOTH.state.type === 'question') {
            BOOTH.show_question(BOOTH.state.arg);
        } else if (BOOTH.state.type === 'seal') {
             $('#seal_div').processTemplate(BOOTH.state.data);
             BOOTH.show($('#seal_div'));
        } else if (BOOTH.state.type === 'audit') {
             $('#audit_div').processTemplate(BOOTH.state.data);
             BOOTH.show($('#audit_div'));
        }
    } else {
        // Default start
        BOOTH.show_election();
    }
};

// set up the message when navigating away
BOOTH.started_p = false;

window.onbeforeunload = function(evt) {
  if (!BOOTH.started_p)
    return;

  if (typeof evt == 'undefined') {
    evt = window.event;
  }

  var message = "Wenn du jetzt die Seite verlässt, während du deinen Stimmzettel noch ausfüllst, wird dieser nicht gespeichert.";

  if (evt) {
    evt.returnValue = message;
  }

  return message;
};

BOOTH.exit = function() {
    if (confirm("Möchtest du die Wahlkabine wirklich verlassen und deinen jetztigen Stimmzettel verwerfen?")) {
        BOOTH.started_p = false;
        window.location = BOOTH.election.cast_url;
    }
};

BOOTH.setup_ballot = function(election) {
  BOOTH.ballot = {};

  // dirty markers for encryption (mostly for async)
  BOOTH.dirty = [];

  // each question starts out with an empty array answer
  // and a dirty bit to make sure we encrypt
  BOOTH.ballot.answers = [];
  $(BOOTH.election.questions).each(function(i,x){
    BOOTH.ballot.answers[i] = [];
    BOOTH.dirty[i] = true;
  });
};

// all ciphertexts to null
BOOTH.reset_ciphertexts = function() {
  _(BOOTH.encrypted_answers).each(function(enc_answer, ea_num) {
    BOOTH.launch_async_encryption_answer(ea_num);
  });
};

BOOTH.log = function(msg) {
  if (typeof(console) != undefined)
    console.log(msg);
};

BOOTH.setup_workers = function(election_raw_json) {
  // async?
  if (!BOOTH.synchronous) {
      // prepare spots for encrypted answers
      // and one worker per question
      BOOTH.encrypted_answers = [];
      BOOTH.answer_timestamps = [];
      BOOTH.worker = new window.Worker("boothworker-single.js");
      BOOTH.worker.postMessage({
        'type': 'setup',
        'election' : election_raw_json
      });

      BOOTH.worker.onmessage = function(event) {
        // logging
        if (event.data.type == 'log')
          return BOOTH.log(event.data.msg);

        // result of encryption
        if (event.data.type == 'result') {
          // this check ensures that race conditions
          // don't screw up votes.
          if (event.data.id == BOOTH.answer_timestamps[event.data.q_num]) {
            BOOTH.encrypted_answers[event.data.q_num] = HELIOS.EncryptedAnswer.fromJSONObject(event.data.encrypted_answer, BOOTH.election);
            BOOTH.log("got encrypted answer " + event.data.q_num);
          } else {
            BOOTH.log("no way jose");
          }
        }
      };

      $(BOOTH.election.questions).each(function(q_num, q) {
        BOOTH.encrypted_answers[q_num] = null;
      });
  }
};

function escape_html(content) {
  return $('<div/>').text(content).html();
}

BOOTH.setup_election = function(raw_json, election_metadata) {
  // IMPORTANT: we use the raw JSON for safer hash computation
  // so that we are using the JSON serialization of the SERVER
  // to compute the hash, not the JSON serialization in JavaScript.
  // the main reason for this is unicode representation: the Python approach
  // appears to be safer.
  BOOTH.election = HELIOS.Election.fromJSONString(raw_json);

  // FIXME: we shouldn't need to set both, but right now we are doing so
  // because different code uses each one. Bah. Need fixing.
  BOOTH.election.hash = b64_sha256(raw_json);
  BOOTH.election.election_hash = BOOTH.election.hash

  // async?
  BOOTH.setup_workers(raw_json);

  document.title += ' - ' + BOOTH.election.name;

  // escape election fields
  $(['description', 'name']).each(function(i, field) {
    BOOTH.election[field] = escape_html(BOOTH.election[field]);
  });

  // TODO: escape question and answers

  // whether the election wants candidate order randomization or not
  // we set up an ordering array so that the rest of the code is
  // less error-prone. 
  BOOTH.election.question_answer_orderings = [];
  $(BOOTH.election.questions).each(function(i, question) {
    var ordering = new Array(question.answers.length);

    // initialize array so it is the identity permutation
    $(ordering).each(function(j, answer) {ordering[j]=j;});

    // if we want reordering, at election or question level, then we shuffle the array
    if ((election_metadata && election_metadata.randomize_answer_order) || question.randomize_answer_order) {
      shuffleArray(ordering);
    }

    BOOTH.election.question_answer_orderings[i] = ordering;
  });

  $('#header').processTemplate({'election' : BOOTH.election, 'election_metadata': BOOTH.election_metadata});
  $('#footer').processTemplate({'election' : BOOTH.election, 'election_metadata': BOOTH.election_metadata});
  BOOTH.setup_ballot();
};

BOOTH.show = function(el) {
  $('.panel').hide();
  el.show();
  return el;
};

BOOTH.show_election = function() {
  BOOTH.state = {type: 'election'};
  BOOTH.show($('#election_div')).processTemplate({'election' : BOOTH.election, 'election_metadata': BOOTH.election_metadata});
};

BOOTH.launch_async_encryption_answer = function(question_num) {
   BOOTH.answer_timestamps[question_num] = new Date().getTime();
   BOOTH.encrypted_answers[question_num] = null;
   BOOTH.dirty[question_num] = false;
   BOOTH.worker.postMessage({
      'type' : 'encrypt',
      'q_num': question_num,
      'answer' : BOOTH.ballot.answers[question_num],
      'id' : BOOTH.answer_timestamps[question_num]
   });
};

// check if the current question is ok
BOOTH.validate_question = function(question_num) {
    // check if enough answers are checked
    if (BOOTH.ballot.answers[question_num].length < BOOTH.election.questions[question_num].min) {
        alert('Du musst mindestens ' + BOOTH.election.questions[question_num].min + ' Optionen auswählen.');
        return false;
    }

    // if we need to launch the worker, let's do it
    if (!BOOTH.synchronous) {
       // we need a unique ID for this to ensure that old results
       // don't mess things up. Using timestamp.
       // check if dirty
       if (BOOTH.dirty[question_num]) {
         BOOTH.launch_async_encryption_answer(question_num);
       }
    }
    return true;
};

BOOTH.validate_and_confirm = function(question_num) {
  if (BOOTH.validate_question(question_num)) {
      BOOTH.seal_ballot();
  }
};

BOOTH.next = function(question_num) {
    if (BOOTH.validate_question(question_num)) {
        BOOTH.show_question(question_num + 1);
    }
};

BOOTH.previous = function(question_num) {
    if (BOOTH.validate_question(question_num)) {
        BOOTH.show_question(question_num - 1);
    }
};

// http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
function shuffleArray(array) {
  var currentIndex = array.length
    , temporaryValue
    , randomIndex
    ;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {
     // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

BOOTH.show_question = function(question_num) {
  BOOTH.state = {type: 'question', arg: question_num};
  BOOTH.started_p = true;

  // the first time we hit the last question, we enable the review all button
  if (question_num == BOOTH.election.questions.length -1)
    BOOTH.all_questions_seen = true;

  BOOTH.show_progress('1');
  BOOTH.show($('#question_div')).processTemplate({'question_num' : question_num,
                      'last_question_num' : BOOTH.election.questions.length - 1,
                      'question' : BOOTH.election.questions[question_num], 'show_reviewall' : BOOTH.all_questions_seen,
		      'answer_ordering': BOOTH.election.question_answer_orderings[question_num]
                });

  // fake clicking through the answers, to trigger the disabling if need be
  // first we remove the answers array
  var answer_array = BOOTH.ballot.answers[question_num];
  BOOTH.ballot.answers[question_num] = [];

  // we should not set the dirty bit here, so we save it away
  var old_dirty = BOOTH.dirty[question_num];
  $(answer_array).each(function(i, ans) {
    BOOTH.click_checkbox_script(question_num, ans, true);
  });
  BOOTH.dirty[question_num] = old_dirty;
};



BOOTH.click_checkbox_script = function(question_num, answer_num) {
  document.forms['answer_form']['answer_'+question_num+'_'+answer_num].click();
};

BOOTH.click_checkbox = function(question_num, answer_num, checked_p) {
  // keep track of dirty answers that need encrypting
  BOOTH.dirty[question_num] = true;

  if (checked_p) {
     // multiple click events shouldn't screw this up
     if ($(BOOTH.ballot.answers[question_num]).index(answer_num) == -1)
        BOOTH.ballot.answers[question_num].push(answer_num);

     $('#answer_label_' + question_num + "_" + answer_num).addClass('selected');
  } else {
     BOOTH.ballot.answers[question_num] = UTILS.array_remove_value(BOOTH.ballot.answers[question_num], answer_num);
     $('#answer_label_' + question_num + "_" + answer_num).removeClass('selected');
  }

  if (BOOTH.election.questions[question_num].max != null && BOOTH.ballot.answers[question_num].length >= BOOTH.election.questions[question_num].max) {
     // disable the other checkboxes
     $('.ballot_answer').each(function(i, checkbox) {
        if (!checkbox.checked)
            checkbox.disabled = true;
     });

     // do the warning only if the question allows more than one option, otherwise it's confusing
     if (BOOTH.election.questions[question_num].max > 1) {
        $('#warning_box').html("Maximale Anzahl an Optionen ausgewählt.<br />Um eine andere Option zu wählen, hebe bitte zuerst eine bestehende Auswahl auf.");

     }
  } else {
     // enable the other checkboxes
     $('.ballot_answer').each(function(i, checkbox) {
       checkbox.disabled = false;
     });
     $('#warning_box').html("");
     if (BOOTH.election.questions[question_num].max != null && (BOOTH.ballot.answers[question_num].length < BOOTH.election.questions[question_num].max)) {
        $('#warning_box').html("Du darfst insgesamt bis zu " + BOOTH.election.questions[question_num].max + " Auswahlmöglichkeiten treffen.");
     }
  }
};

BOOTH.show_processing_before = function(str_to_execute) {
    var msg = (BOOTH.language === 'en') ? "Processing..." : "Verarbeiten...";
    $('#processing_div').html("<h3 align='center'>" + msg + "</h3>");
    BOOTH.show($('#processing_div'));

    // add a timeout so browsers like Safari actually display the processing message
    setTimeout(str_to_execute, 250);
};

BOOTH.show_encryption_message_before = function(func_to_execute) {
    BOOTH.show_progress('2');
    BOOTH.show($('#encrypting_div'));

    func_to_execute();
};

BOOTH.load_and_setup_election = function(election_url) {
    // the hash will be computed within the setup function call now
    $.get(election_url, function(raw_json) {
        // let's also get the metadata
        $.getJSON(election_url + "/meta", {}, function(election_metadata) {
          BOOTH.election_metadata = election_metadata;
          BOOTH.setup_election(raw_json, election_metadata);
          BOOTH.show_election();
          BOOTH.election_url = election_url;
        });
    });


    if (USE_SJCL) {
      // get more randomness from server
      $.get(election_url + "/get-randomness", {}, function(raw_json) {
        sjcl.random.addEntropy(JSON.parse(raw_json).randomness);
      });
    }
};

BOOTH.hide_progress = function() {
  $('#progress_div').hide();
};

BOOTH.show_progress = function(step_num) {
    $('#progress_div').show();
    $(['1','2','3','4']).each(function(n, step) {
        if (step == step_num)
            $('#progress_' + step).attr('class', 'selected');
        else
            $('#progress_' + step).attr('class', 'unselected');
    });
};

BOOTH.so_lets_go = function () {
    BOOTH.hide_progress();

    BOOTH.setup_templates();

    // election URL
    var election_url = $.query.get('election_url');
    BOOTH.load_and_setup_election(election_url);
};

BOOTH.nojava = function() {
  // in the case of Chrome, we get here when Java
  // is disabled, instead of detecting the problem earlier.
  // because navigator.javaEnabled() still returns true.
  // $('#election_div').hide();
  // $('#error_div').show();
    USE_SJCL = true;
    sjcl.random.startCollectors();
    BigInt.setup(BOOTH.so_lets_go);
};

BOOTH.ready_p = false;

$(document).ready(function() {
    if (USE_SJCL) {
      sjcl.random.startCollectors();
    }

    // we're asynchronous if we have SJCL and Worker
    BOOTH.synchronous = !(USE_SJCL && window.Worker);

    BigInt.setup(BOOTH.so_lets_go, BOOTH.nojava);
});


BOOTH.check_encryption_status = function() {
  var progress = BOOTH.progress.progress();
  if (progress == "" || progress == null)
    progress = "0";

  $('#percent_done').html(progress);
};

BOOTH._after_ballot_encryption = function() {
    // if already serialized, use that, otherwise serialize
    BOOTH.encrypted_vote_json = BOOTH.encrypted_ballot_serialized || JSON.stringify(BOOTH.encrypted_ballot.toJSONObject());

    var do_hash = function() {
       BOOTH.encrypted_ballot_hash = b64_sha256(BOOTH.encrypted_vote_json); // BOOTH.encrypted_ballot.get_hash();
       window.setTimeout(show_cast, 0);
    };

    var show_cast = function() {
      var data = {'cast_url': BOOTH.election.cast_url,
        'encrypted_vote_json': BOOTH.encrypted_vote_json,
        'encrypted_vote_hash' : BOOTH.encrypted_ballot_hash,
        'election_uuid' : BOOTH.election.uuid,
        'election_hash' : BOOTH.election_hash,
        'election': BOOTH.election,
        'election_metadata': BOOTH.election_metadata,
        'questions' : BOOTH.election.questions,
        'choices' : BALLOT.pretty_choices(BOOTH.election, BOOTH.ballot)};
      
      BOOTH.state = {type: 'seal', data: data};
      $('#seal_div').processTemplate(data);
      BOOTH.show($('#seal_div'));
      BOOTH.encrypted_vote_json = null;
    };

    window.setTimeout(do_hash, 0);
};

BOOTH.total_cycles_waited = 0;

// wait for all workers to be done
BOOTH.wait_for_ciphertexts = function() {
    BOOTH.total_cycles_waited += 1;

    var answers_done = _.reject(BOOTH.encrypted_answers, _.isNull);
    var percentage_done = Math.round((100 * answers_done.length) / BOOTH.encrypted_answers.length);

    if (BOOTH.total_cycles_waited > 250) {
      alert('Beim Verschlüsseln deiner Stimme ist ein Problem aufgetreten.\nBitte schreibe sofort an info@asta-hfmdk-frankfurt.de und teile mit, dass der Vorgang bei ' + percentage_done + '% stehen geblieben ist oder versuche es nochmal.');
      return;
    }

    if (percentage_done < 100) {
      setTimeout(BOOTH.wait_for_ciphertexts, 500);
      $('#percent_done').html(percentage_done + '');
      return;
    }

    BOOTH.encrypted_ballot = HELIOS.EncryptedVote.fromEncryptedAnswers(BOOTH.election, BOOTH.encrypted_answers);

    BOOTH._after_ballot_encryption();
};

BOOTH.seal_ballot_raw = function() {
    if (BOOTH.synchronous) {
      BOOTH.progress = new UTILS.PROGRESS();
      var progress_interval = setInterval("BOOTH.check_encryption_status()", 500);
      BOOTH.encrypted_ballot = new HELIOS.EncryptedVote(BOOTH.election, BOOTH.ballot.answers, BOOTH.progress);
      clearInterval(progress_interval);
      BOOTH._after_ballot_encryption();
    } else {
      BOOTH.total_cycles_waited = 0;
      BOOTH.wait_for_ciphertexts();
    }
};

BOOTH.seal_ballot = function() {
    BOOTH.show_progress('2');
    BOOTH.show_encryption_message_before(BOOTH.seal_ballot_raw, true);
    $('#percent_done_container').show();
};

BOOTH.audit_ballot = function() {
    BOOTH.audit_trail = $.toJSON(BOOTH.encrypted_ballot.get_audit_trail());
    var data = {'audit_trail' : BOOTH.audit_trail, 'election_url' : BOOTH.election_url};
    BOOTH.state = {type: 'audit', data: data};
    BOOTH.show($('#audit_div')).processTemplate(data);
};

BOOTH.post_audited_ballot = function() {
  $.post(BOOTH.election_url + "/post-audited-ballot", {'audited_ballot': BOOTH.audit_trail}, function(result) {
    alert('Dieser Prüfungs-Stimmzettel wurde veröffentlicht.\nAchtung!!!: Dieser Zettel dient nur der Überprüfung und wird nicht!! in die eigentliche Auszählung einbezogen.\nKlicke auf „Zurück zur Wahl“, um einen neuen Stimmzettel abzugeben, damit deine Stimme zählt.');

  });
};

BOOTH.cast_ballot = function() {
    // show progress spinner
    $('#loading_div').show();
    $('#proceed_button').attr('disabled', 'disabled');

    // at this point, we delete the plaintexts by resetting the ballot
    BOOTH.setup_ballot(BOOTH.election);

    // clear the plaintext from the encrypted
    if (BOOTH.encrypted_ballot)
       BOOTH.encrypted_ballot.clearPlaintexts();

    BOOTH.encrypted_ballot_serialized = null;

    // remove audit trail
    BOOTH.audit_trail = null;

    // we're ready to leave the site
    BOOTH.started_p = false;

    // submit the form
    var form = $('#send_ballot_form');
    if (BOOTH.language) {
        var action = form.attr('action');
        var separator = action.indexOf('?') !== -1 ? '&' : '?';
        form.attr('action', action + separator + 'lang=' + BOOTH.language);
    }
    form.submit();
};

BOOTH.show_receipt = function() {
    UTILS.open_window_with_content("Dein Stimmzettel-Tracker für " + BOOTH.election.name + ": " + BOOTH.encrypted_ballot_hash);
};

BOOTH.do_done = function() {
  BOOTH.started_p = false;
};

</script>
<div id="page">
  <div id="progress_div" style="display:none">
      <table>
          <tr>
              <td id="progress_1">(1) Wählen</td>
              <td id="progress_2">(2) Überprüfung</td>
              <td id="progress_3">(3) Abschicken</td>
          </tr>
      </table>
  </div>
  <div id="election_div" class="panel">
    <h3 id="election_loading_msg">Prüfe Funktionen und lade Wahlkabine…</h3>
    <div class="text-center"><img src="loading.gif" /><br /><span id="election_loading_submsg">Das dauert nicht lange...</span></div>
  </div>

  <div id="error_div" class="panel" style="display: none;">
    <h3>Es gibt ein Problem!</h3>
    <p>
      Es scheint, dass in deinem Browser Java nicht aktiviert ist. Helios benötigt Java, um die Verschlüsselung direkt im Browser durchzuführen.
    </p>
    <p>
      Du kannst Java möglicherweise installieren, indem du <a target="_new" href="http://java.com">java.com</a> besuchst. Oder nutze einen anderen Browser/Gerät!
    </p>
  </div>

  <div id="question_div" class="panel">
  </div>

  <div id="processing_div" class="panel" style="display:none;">
      <h3 class="text-center">Verarbeiten....</h3>
  </div>

  <div id="encrypting_div" class="panel" style="display:none;">
      <h3 class="text-center"><span id="encrypting_message">Dieser Stimmzettel wird nun verschlüsselt.</span><br />
          <img src="encrypting.gif" /> <span style="font-size:0.7em; display:none;" id="percent_done_container">(<span id="percent_done">0</span>%)</span></h3>

      <p class="text-center"><b id="encrypting_submessage">Das dauert nicht lange :)</b>
  </div>

  <div id="seal_div" class="panel">
  </div>

  <div id="audit_div" class="panel">
  </div>

</div>

<br clear="both" />
</div>
<div id="footer" class="edge_footer">&nbsp;</div>
</div>
<div id="applet_div">
</div>

<script>
  // Hilfsfunktion: erstelle eine URL, die alle bestehenden query-params erhält
  function buildLangUrl(lang) {
    var loc = window.location;
    // Use URL and URLSearchParams to preserve other params
    var url = new URL(loc.href);
    if (lang) {
      url.searchParams.set('lang', lang);
    } else {
      url.searchParams.delete('lang');
    }
    return url.toString();
  }

  // Setze hrefs so, dass andere Parameter (z.B. election id) erhalten bleiben
  document.addEventListener('DOMContentLoaded', function() {
    var de = document.getElementById('lang-de');
    var en = document.getElementById('lang-en');
    if (de) de.href = buildLangUrl('de');
    if (en) en.href = buildLangUrl('en');

    // Markiere die momentan aktive Sprache (optisch)
    var params = new URLSearchParams(window.location.search);
    var current = (params.get('lang') || localStorage.getItem('helios_language') || 'de').toLowerCase(); // default deutsch
    if (current === 'en') {
      en.classList.add('lang-active');
      de.classList.remove('lang-active');

      // Translate loading message immediately
      var msg = document.getElementById('election_loading_msg');
      var submsg = document.getElementById('election_loading_submsg');
      if (msg) msg.innerText = "Checking functions and loading voting booth...";
      if (submsg) submsg.innerText = "This won't take long...";
    } else {
      de.classList.add('lang-active');
      en.classList.remove('lang-active');
    }
  });
</script>

</body>
</html>
