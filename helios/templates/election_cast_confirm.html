{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8">
  <title>Wahlkabine Cast Confirm</title>
  <link rel="stylesheet" type="text/css" href="{% static 'booth.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'forms.css' %}" />
  <script language="javascript" src="{% static 'js/jquery-1.4.2.min.js' %}"></script>
</head>
<body>
<div id="wrapper">
  <div id="banner" class="edge">
    <div class="banner-content" style="position:relative; display:flex; align-items:center; justify-content:center;">
        <div id="lang-switch" style="position:absolute; left:12px; top:0; bottom:0; display:flex; gap:6px; align-items:center;">
            <a id="lang-de" class="lang-link" href="#" onclick="switch_language('de'); return false;" title="Deutsch" aria-label="Deutsch">
                <img src="{% static 'lang/flag-de.svg' %}" alt="DE" style="width:26px; height:18px; vertical-align:middle; border-radius:2px;"/>
            </a>
            <a id="lang-en" class="lang-link" href="#" onclick="switch_language('en'); return false;" title="English" aria-label="English">
                <img src="{% static 'lang/flag-en.svg' %}" alt="EN" style="width:26px; height:18px; vertical-align:middle; border-radius:2px;"/>
            </a>
        </div>
        <span class="banner-title">Wahlkabine</span>
        <a class="banner-exit" href="{% url "election@view" election.uuid %}" style="position:absolute; right:12px;">Verlassen</a>
    </div>
  </div>
  <div id="content">
    <div id="header">
      <h1 id="election_name">{{ election.name }}</h1>
    </div>

    <script language="javascript">
    function switch_language(lang) {
        localStorage.setItem('helios_language', lang);
        var url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        window.location.href = url.toString();
    }

    $(document).ready(function() {
      $('#waiting_div').hide();
      
      // Language handling
      var params = new URLSearchParams(window.location.search);
      var lang = params.get('lang') || localStorage.getItem('helios_language') || 'de';
      
      // Ensure consistency
      if (lang) {
          localStorage.setItem('helios_language', lang);
      }
      // console.log("Helios language: " + lang);
      if (lang === 'en') {
          $('#lang-en').addClass('lang-active');
          $('#lang-de').removeClass('lang-active');

          // Banner
          $('.banner-title').text('Voting Booth');
          $('.banner-exit').text('Exit');
          
          // Header
          $('title').text('Vote - Digital Voting Booth');
          
          // Waiting div
          $('#waiting_div h2').text('Submitting your ballot...');
          $('#waiting_div p').first().text('Please wait while we verify and cast your ballot.');
          
          // Onbeforeunload message
          window.onbeforeunload = function(evt) {
              if (ready_to_unload) return;
              if (typeof evt == 'undefined') evt = window.event;
              var message = "You have not cast your ballot yet! Complete the process if you want your vote to count.";
              if (evt) evt.returnValue = message;
              return message;
          };
          
          // Translate content in included templates
          translate_content();
      } else {
          $('#lang-de').addClass('lang-active');
          $('#lang-en').removeClass('lang-active');
      }
    });

    function translate_content() {
        // Translations for _castconfirm_password.html
        $('.trans-voter-id-label').text('First Name:');
        $('.trans-password-label').text('Password:');
        $('.trans-login-button').val('Login');
        $('.trans-cast-button').val('Authenticate & Cast Ballot');
        $('.trans-bad-login').text('Your Voter ID or Password was incorrect. This is not your HfMDK account login. Please try again using the credentials from the email!');
        
        var help_email = '{{election.help_email|escapejs}}';
        $('.trans-help-text-1').html('You can find your Voter ID and Password in the email you received.<br>If you cannot find your credentials, please contact AStA at: <tt>' + help_email + '</tt>.');
        $('.trans-help-text-2').text('You can cast as many ballots as you want. Only the last one counts.');
        
        // Translations for _castconfirm_docast.html
        var voter_display = '{{voter.display_html_big|escapejs}}';
        $('.trans-logged-in-as-container').html('You are logged in as <u>' + voter_display + '</u>');
        
        $('.trans-submit-ballot').text('Cast this ballot');
        $('.trans-submit-info').html('<br />You can cast as many ballots as you want.<br />Only the last one counts.');
        $('.trans-cancel-button').text('Cancel');
        $('.trans-cancel-info').html('If you cancel now, your ballot will <em>NOT</em> be recorded.<br />You can restart the voting process at any time.');
        $('.trans-voting-stopped').text('Sorry, voting has ended.');
        $('.trans-voting-not-started').text('Sorry, voting has not started yet.');
        
        // Update confirm dialog for cancel button
        var cancelUrl = '{% url "election@view" election.uuid %}';
        $('.trans-cancel-button').attr('onclick', "if (confirm('Are you sure you want to delete this ballot and NOT cast it?')) {document.location='" + cancelUrl + "';}");

        // Update password login form action to include lang
        var form = $('form[action*="password-voter-login"]');
        if (form.length > 0) {
            var action = form.attr('action');
            var separator = action.indexOf('?') !== -1 ? '&' : '?';
            form.attr('action', action + separator + 'lang=en');
        }

        // General page translations
        $('.title').text('Log in to cast your ballot!');
        $('#progress_1').text('(1) Select');
        $('#progress_2').text('(2) Review');
        $('#progress_3').text('(3) Submit');
        $('.trans-ballot-hash-label').text('Your ballot tracker is:');
        $('.trans-election-hash-label').text('Election Fingerprint:');
    }

    function show_waiting() {
      $('#all_forms').hide();
      $('#waiting_div').show();
    }

    // FIXME: set this to false once it's clear how to set it back to true
    // so that it's not easy to forget to cast a ballot
    var ready_to_unload = true;

    window.onbeforeunload = function(evt) {
      if (ready_to_unload)
        return;

      if (typeof evt == 'undefined') {
        evt = window.event;
      }
      
      var message = "Du hast deinen Stimmzettel noch nicht abgegeben! Schließe den Wahlvorgang ab, wenn deine Stimme gezählt werden soll.";

      if (evt) {
        evt.returnValue = message;
      }
      
      return message;
    };
    </script>

    <div id="page">
      <div id="progress_div">
          <table>
              <tr>
                  <td id="progress_1" class="unselected">(1) Wählen</td>
                  <td id="progress_2" class="unselected">(2) Überprüfung</td>
                  <td id="progress_3" class="selected">(3) Abschicken</td>
              </tr>
          </table>
      </div>

      <div class="panel">
        <h2 class="title">Einloggen! Um deine Stimme abzugeben.</h2>

        <div id="waiting_div">
       
        </div>

        

        <div id="all_forms">

        {% if voter %}

        {% include "_castconfirm_docast.html" %}

        {% else %}

        {% if show_password %}
        {% with cast_ballot="1" %}
        {% include "_castconfirm_password.html" %}
        {% endwith %}

        {% else %}

        {% if user %}
        <h1>Entschuldigung!<h1>
        <b>Entschuldigung, du bist <em>
          {% if election.openreg %}
            <u>nicht wahlberechtigt</u></em> für diese Wahl.
          {% else %}
            nicht registriert</em> für diese Wahl, und die Registrierung ist geschlossen.
          {% endif %}
          </b><br /></p>
        <p>
          [<a href="{% url "election@view" election.uuid %}">zurück zur Hauptseite der Wahl</a>]
        </p>
        {% else %}
        <p>
        {% if election.openreg %}

          {% if election.eligibility %}
          {% else %}
            Diese Wahl steht <em>jedem*r</em> offen, melde dich einfach mit deinem bevorzugten Konto an.
          {% endif %}

        {% else %}
          Diese Wahl steht nur <em>registrierten Wähler*innen</em> offen. Logge dich mit
          demselben Konto ein, mit dem du dich registriert hast.
        {% endif %}
        </p>

        {{login_box|safe}}

        <br />
        Keine Sorge, wir speichern deinen Stimmzettel, während du dich anmeldest.
        {% endif %}

        {% endif %}
        </p>
        {# this closes the IF ELSE of this being password_only #}
        {% endif %}

        </div>

        <div style="margin-bottom: 20px;">
        <span class="trans-ballot-hash-label">Dein Stimmzettel-Hash lautet:</span><br>
        <tt class="tracker-hash">{{vote_fingerprint}}</tt>
        <br><br>
        </div>
        
      </div>
    </div>
    <br clear="both" />
  </div>
  <div id="footer" class="edge_footer">
    <div style="text-align:center; width: 100%; padding: 3px 30px 3px 5px;">
      <span>
          <span class="trans-election-hash-label">Wahl-Hash:</span> <span id="election_hash" style="font-weight:bold;">{{ election.hash }}</span>
      </span>
    </div>
  </div>
</div>
</body>
</html>